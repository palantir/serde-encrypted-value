# This file was generated by the excavator check 'excavator/manage-circleci' as specified in .circleci/template.sh.
# To request a modification to the general template, file an issue on Excavator.
# To manually manage the CircleCI configuration for this project, remove the .circleci/template.sh file.

version: 2.1
jobs:
  build:
    docker: [{ image: cimg/rust:1.93.1 }]
    environment:
      CARGO_BUILD_RUSTFLAGS: -Dwarnings
      RUST_BACKTRACE: 1
    steps:
      - checkout
      - restore_cache:
          key: registry
      - run: cargo generate-lockfile
      - save_cache:
          key: registry-{{ .BuildNum }}
          paths:
            - /home/circleci/.cargo/registry/index
      - restore_cache:
          key: deps-1.93.1-{{ checksum "Cargo.lock" }}
      - run: cargo fmt --all -- --check
      - run: cargo clippy --all --all-targets
      - run: cargo test --all
      - save_cache:
          key: deps-1.93.1-{{ checksum "Cargo.lock" }}
          paths:
            - target
            - /home/circleci/.cargo/registry/cache
      - run: |
          set -euo pipefail

          if [[ -z ${CIRCLE_TAG+x} ]]; then
            exit 0
          fi

          packages=$(cargo metadata --format-version=1 --no-deps | jq -cr '.packages[]')
          while IFS= read -r package; do
            name=$(echo "$package" | jq -r .name)

            if [[ $(echo "$package" | jq .publish) != "null" ]]; then
              echo Publishing disabled for $name, skipping
              continue
            fi

            manifest=$(echo "$package" | jq -r .manifest_path)
            cargo publish \
              --manifest-path "$manifest" \
              --no-verify
          done \<<< "$packages"

  circle-all:
    docker: [{ image: 'busybox:1.36.1@sha256:6d9ac9237a84afe1516540f40a0fafdc86859b2141954b4d643af7066d598b74' }]
    resource_class: small
    steps:
      - run: {command: echo "All required jobs finished successfully"}

workflows:
  version: 2
  build:
    jobs:
      - build:
          filters: { tags: { only: /.*/ } }

      # Catch-all for all required checks
      - circle-all:
          requires: [ build ]
          filters: { tags: { only: /.*/ } }
